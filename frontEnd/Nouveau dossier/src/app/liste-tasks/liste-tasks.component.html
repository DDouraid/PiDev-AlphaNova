<div class="main-content">
  <div class="kanban-container">

    <!-- Section Statistiques -->
    <div class="stats-container mb-5">
      <h3 class="stats-title">Progression des Tâches</h3>
      
      <div class="progress mb-3">
        <div class="progress-bar bg-primary" role="progressbar" 
             [ngClass]="{'hide-text': todoPercentage < 20}"
             [style.width]="todoPercentage + '%'" 
             [attr.aria-valuenow]="todoPercentage" 
             aria-valuemin="0" 
             aria-valuemax="100">
          À Faire: {{ todoPercentage | number:'1.0-1' }}%
        </div>
        <div class="progress-bar bg-warning" role="progressbar" 
             [ngClass]="{'hide-text': inProgressPercentage < 20}"
             [style.width]="inProgressPercentage + '%'" 
             [attr.aria-valuenow]="inProgressPercentage" 
             aria-valuemin="0" 
             aria-valuemax="100">
          En Cours: {{ inProgressPercentage | number:'1.0-1' }}%
        </div>
        <div class="progress-bar bg-success" role="progressbar" 
             [ngClass]="{'hide-text': donePercentage < 20}"
             [style.width]="donePercentage + '%'" 
             [attr.aria-valuenow]="donePercentage" 
             aria-valuemin="0" 
             aria-valuemax="100">
          Terminé: {{ donePercentage | number:'1.0-1' }}%
        </div>
      </div>
      
      <div class="stats-details">
        <p class="total-tasks mb-2">Total des Tâches: <strong>{{ totalTasks }}</strong></p>
        <div class="badges-container">
          <span class="badge bg-primary me-2">
            <i class="fas fa-list-ul me-1"></i> À Faire: {{ todoTasks.length }}
          </span>
          <span class="badge bg-warning me-2">
            <i class="fas fa-spinner me-1"></i> En Cours: {{ inProgressTasks.length }}
          </span>
          <span class="badge bg-success">
            <i class="fas fa-check-circle me-1"></i> Terminé: {{ doneTasks.length }}
          </span>
        </div>
      </div>
    </div>

    <!-- Header et bouton Add -->
    <div class="header-container d-flex justify-content-between align-items-center mb-4">
      <button class="btn btn-primary add-task-btn" (click)="openAddModal()">
        <i class="fas fa-plus me-2"></i>Add Task
      </button>
    </div>

    <!-- Tableau Kanban -->
    <div class="kanban-board">
      <!-- Colonne To Do -->
      <div class="kanban-column">
        <h2 class="column-header bg-primary">
          <i class="fas fa-list-ul me-2"></i>To Do
        </h2>
        <div cdkDropList
             id="todoList"
             [cdkDropListData]="todoTasks"
             [cdkDropListConnectedTo]="['inProgressList', 'doneList']"
             class="task-list"
             (cdkDropListDropped)="drop($event)">
             
          <div class="task-card" *ngFor="let task of todoTasks" cdkDrag>
            <div class="task-content">
              <h5><i class="fas fa-tag text-primary me-2"></i>{{ task.title }}</h5>
              <p class="task-description">{{ task.description }}</p>
              <small class="task-dates">
                <i class="far fa-calendar-alt me-1"></i>
                {{ task.startDate | date:'shortDate' }} - {{ task.endDate | date:'shortDate' }}
              </small>
              <p><i class="fas fa-user me-1"></i>User ID: {{ task.userId || 'N/A' }}</p> <!-- Display userId -->
            </div>
            <div class="task-actions">
              <button class="btn btn-sm btn-warning me-2" (click)="openUpdateModal(task)">
                <i class="fas fa-edit me-1"></i>Edit
              </button>
              <button class="btn btn-sm btn-danger" (click)="deleteTask(task.id)">
                <i class="fas fa-trash me-1"></i>Delete
              </button>
            </div>
          </div>
          
          <div *ngIf="todoTasks.length === 0" class="empty-state">
            <i class="far fa-smile-beam"></i>
            <p>Aucune tâche à faire</p>
          </div>
        </div>
      </div>

      <!-- Colonne In Progress -->
      <div class="kanban-column">
        <h2 class="column-header bg-warning">
          <i class="fas fa-spinner me-2"></i>In Progress
        </h2>
        <div cdkDropList
             id="inProgressList"
             [cdkDropListData]="inProgressTasks"
             [cdkDropListConnectedTo]="['todoList', 'doneList']"
             class="task-list"
             (cdkDropListDropped)="drop($event)">
             
          <div class="task-card in-progress" *ngFor="let task of inProgressTasks" cdkDrag>
            <div class="task-content">
              <h5><i class="fas fa-tag text-warning me-2"></i>{{ task.title }}</h5>
              <p class="task-description">{{ task.description }}</p>
              <small class="task-dates">
                <i class="far fa-calendar-alt me-1"></i>
                {{ task.startDate | date:'shortDate' }} - {{ task.endDate | date:'shortDate' }}
              </small>
              <p><i class="fas fa-user me-1"></i>User ID: {{ task.userId || 'N/A' }}</p> <!-- Display userId -->
            </div>
            <div class="task-actions">
              <button class="btn btn-sm btn-warning me-2" (click)="openUpdateModal(task)">
                <i class="fas fa-edit me-1"></i>Edit
              </button>
              <button class="btn btn-sm btn-danger" (click)="deleteTask(task.id)">
                <i class="fas fa-trash me-1"></i>Delete
              </button>
            </div>
          </div>
          
          <div *ngIf="inProgressTasks.length === 0" class="empty-state">
            <i class="far fa-smile-beam"></i>
            <p>Aucune tâche en cours</p>
          </div>
        </div>
      </div>

      <!-- Colonne Done -->
      <div class="kanban-column">
        <h2 class="column-header bg-success">
          <i class="fas fa-check-circle me-2"></i>Done
        </h2>
        <div cdkDropList
             id="doneList"
             [cdkDropListData]="doneTasks"
             [cdkDropListConnectedTo]="['todoList', 'inProgressList']"
             class="task-list"
             (cdkDropListDropped)="drop($event)">
             
          <div class="task-card done" *ngFor="let task of doneTasks" cdkDrag>
            <div class="task-content">
              <h5><i class="fas fa-tag text-success me-2"></i>{{ task.title }}</h5>
              <p class="task-description">{{ task.description }}</p>
              <small class="task-dates">
                <i class="far fa-calendar-alt me-1"></i>
                {{ task.startDate | date:'shortDate' }} - {{ task.endDate | date:'shortDate' }}
              </small>
              <p><i class="fas fa-user me-1"></i>User ID: {{ task.userId || 'N/A' }}</p> <!-- Display userId -->
            </div>
            <div class="task-actions">
              <button class="btn btn-sm btn-warning me-2" (click)="openUpdateModal(task)">
                <i class="fas fa-edit me-1"></i>Edit
              </button>
              <button class="btn btn-sm btn-danger" (click)="deleteTask(task.id)">
                <i class="fas fa-trash me-1"></i>Delete
              </button>
            </div>
          </div>
          
          <div *ngIf="doneTasks.length === 0" class="empty-state">
            <i class="far fa-smile-beam"></i>
            <p>Aucune tâche terminée</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Modales -->
    <div class="modal fade" id="addTaskModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="addTaskModalLabel">Add New Task</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form #addTaskForm="ngForm" (ngSubmit)="saveTask()">
              <div class="mb-3">
                <label for="taskUserId" class="form-label">User ID</label>
                <input type="number" 
                       class="form-control" 
                       id="taskUserId" 
                       [(ngModel)]="newTask.userId" 
                       name="userId"
                       required
                       #userId="ngModel"
                       [class.is-invalid]="userId.invalid && (userId.dirty || userId.touched)">
                <div *ngIf="userId.invalid && (userId.dirty || userId.touched)" class="text-danger">
                  L'ID utilisateur est obligatoire.
                </div>
              </div>
              <div class="mb-3">
                <label for="taskTitle" class="form-label">Title</label>
                <input type="text" 
                       class="form-control" 
                       id="taskTitle" 
                       [(ngModel)]="newTask.title" 
                       name="title"
                       required
                       #title="ngModel"
                       [class.is-invalid]="title.invalid && (title.dirty || title.touched)">
                <div *ngIf="title.invalid && (title.dirty || title.touched)" class="text-danger">
                  Le titre est obligatoire.
                </div>
              </div>
              <div class="mb-3">
                <label for="taskDescription" class="form-label">Description</label>
                <textarea class="form-control" 
                          id="taskDescription" 
                          [(ngModel)]="newTask.description" 
                          name="description"
                          required
                          rows="3"
                          #description="ngModel"
                          [class.is-invalid]="description.invalid && (description.dirty || description.touched)"></textarea>
                <div *ngIf="description.invalid && (description.dirty || description.touched)" class="text-danger">
                  La description est obligatoire.
                </div>
              </div>
              <div class="mb-3">
                <label for="startDate" class="form-label">Start Date</label>
                <input type="date" 
                       class="form-control" 
                       id="startDate" 
                       [(ngModel)]="newTask.startDate" 
                       name="startDate"
                       required
                       #startDate="ngModel"
                       [class.is-invalid]="startDate.invalid && (startDate.dirty || startDate.touched)">
                <div *ngIf="startDate.invalid && (startDate.dirty || startDate.touched)" class="text-danger">
                  La date de début est obligatoire.
                </div>
              </div>
              <div class="mb-3">
                <label for="endDate" class="form-label">End Date</label>
                <input type="date" 
                       class="form-control" 
                       id="endDate" 
                       [(ngModel)]="newTask.endDate" 
                       name="endDate"
                       required
                       #endDate="ngModel"
                       [class.is-invalid]="(endDate.invalid || !isValidDateRange()) && (endDate.dirty || endDate.touched)">
                <div *ngIf="endDate.invalid && (endDate.dirty || endDate.touched)" class="text-danger">
                  La date de fin est obligatoire.
                </div>
                <div *ngIf="!endDate.invalid && !isValidDateRange() && (endDate.dirty || endDate.touched)" class="text-danger">
                  La date de fin doit être postérieure à la date de début.
                </div>
              </div>
            </form>
            <!-- Error/Success Messages -->
            <div *ngIf="errorMessage" class="alert alert-danger mt-3">{{ errorMessage }}</div>
            <div *ngIf="successMessage" class="alert alert-success mt-3">{{ successMessage }}</div>
            <!-- Loading Indicator -->
            <div *ngIf="isLoading" class="text-center mt-3">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Chargement...</span>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <button type="button" 
                    class="btn btn-primary" 
                    (click)="saveTask()"
                    [disabled]="!addTaskForm.valid || !isValidDateRange()">Save Task</button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="updateTaskModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="updateTaskModalLabel">Update Task</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form #updateTaskForm="ngForm" (ngSubmit)="saveTask()">
              <div class="mb-3">
                <label for="updateTaskUserId" class="form-label">User ID</label>
                <input type="number" 
                       class="form-control" 
                       id="updateTaskUserId" 
                       [(ngModel)]="newTask.userId" 
                       name="userId"
                       required
                       #userId="ngModel"
                       [class.is-invalid]="userId.invalid && (userId.dirty || userId.touched)">
                <div *ngIf="userId.invalid && (userId.dirty || userId.touched)" class="text-danger">
                  L'ID utilisateur est obligatoire.
                </div>
              </div>
              <div class="mb-3">
                <label for="updateTaskTitle" class="form-label">Title</label>
                <input type="text" 
                       class="form-control" 
                       id="updateTaskTitle" 
                       [(ngModel)]="newTask.title" 
                       name="title"
                       required
                       #title="ngModel"
                       [class.is-invalid]="title.invalid && (title.dirty || title.touched)">
                <div *ngIf="title.invalid && (title.dirty || title.touched)" class="text-danger">
                  Le titre est obligatoire.
                </div>
              </div>
              <div class="mb-3">
                <label for="updateTaskDescription" class="form-label">Description</label>
                <textarea class="form-control" 
                          id="updateTaskDescription" 
                          [(ngModel)]="newTask.description" 
                          name="description"
                          required
                          rows="3"
                          #description="ngModel"
                          [class.is-invalid]="description.invalid && (description.dirty || description.touched)"></textarea>
                <div *ngIf="description.invalid && (description.dirty || description.touched)" class="text-danger">
                  La description est obligatoire.
                </div>
              </div>
              <div class="mb-3">
                <label for="updateStartDate" class="form-label">Start Date</label>
                <input type="date" 
                       class="form-control" 
                       id="updateStartDate" 
                       [(ngModel)]="newTask.startDate" 
                       name="startDate"
                       required
                       #startDate="ngModel"
                       [class.is-invalid]="startDate.invalid && (startDate.dirty || startDate.touched)">
                <div *ngIf="startDate.invalid && (startDate.dirty || startDate.touched)" class="text-danger">
                  La date de début est obligatoire.
                </div>
              </div>
              <div class="mb-3">
                <label for="updateEndDate" class="form-label">End Date</label>
                <input type="date" 
                       class="form-control" 
                       id="updateEndDate" 
                       [(ngModel)]="newTask.endDate" 
                       name="endDate"
                       required
                       #endDate="ngModel"
                       [class.is-invalid]="(endDate.invalid || !isValidDateRange()) && (endDate.dirty || endDate.touched)">
                <div *ngIf="endDate.invalid && (endDate.dirty || endDate.touched)" class="text-danger">
                  La date de fin est obligatoire.
                </div>
                <div *ngIf="!endDate.invalid && !isValidDateRange() && (endDate.dirty || endDate.touched)" class="text-danger">
                  La date de fin doit être postérieure à la date de début.
                </div>
              </div>
            </form>
            <!-- Error/Success Messages -->
            <div *ngIf="errorMessage" class="alert alert-danger mt-3">{{ errorMessage }}</div>
            <div *ngIf="successMessage" class="alert alert-success mt-3">{{ successMessage }}</div>
            <!-- Loading Indicator -->
            <div *ngIf="isLoading" class="text-center mt-3">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Chargement...</span>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <button type="button" 
                    class="btn btn-primary" 
                    (click)="saveTask()"
                    [disabled]="!updateTaskForm.valid || !isValidDateRange()">Update Task</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>